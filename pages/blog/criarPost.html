<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>

    <!-- Favicon  -->

    <!-- Bootstrap link CSS -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

    <!-- CSS link HomePage-->
    <link rel="stylesheet" href="./../../assets/css/style.css" />

    <!-- CSS link Partials-->
    <link rel="stylesheet" href="./../partials/partials.css" />
    
    <!-- CSS link CriarPost-->
    <link rel="stylesheet" href="./criarPost.css" />

    <!-- Link Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Doppio+One&family=Dosis&family=Lato&display=swap" rel="stylesheet" />

    <!-- Script para editor de texto -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@ckeditor/ckeditor5-ckfinder@40.0.0/src/index.min.js"></script>
    <!-- Bootstrap link JavaScript  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  </head>

  <body>
    <my-header></my-header>
    <section class="container">
        <div id="error" class="alert alert-danger" role="alert">
            <span id="error-text"></span>
            <button class="button-error close" type="button" aria-label="Close">
                <span aria-hidden="true">&times</span>
            </button>
        </div>
        <form id="texto-form">
            <input type="text" id="title" placeholder="Inserir um título..." required >
            <div id="editor"></div>

            <div class="buttons-container">
                <input id="reset" class="button" value="Cancelar">
                <input id="submit" class="button" type="submit" value="Publicar">
            </div>
        </form>
    </section>
    <my-footer></my-footer>
    <script src="./../partials/partials.js"></script>
    <script src="./../../services/postService.js"></script>
   
    <script>

        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const id = urlParams.get("id");
        
        const initEditor = async (value = '', defaultTitle = '') => {
            const res = await ClassicEditor.create(document.querySelector('#editor'), {
                
                ckfinder: {
                    uploadUrl: '/uploads'
                }
            })
            if (res) {
                res.data.set(value);
                document.querySelector('#reset').addEventListener('click', () => {
                    document.getElementById("title").value = defaultTitle;
                    res.data.set(value);
                })
                return res;
            }
            return null;
        }
        const addEventSubmit = (editor) => {
            document.querySelector('#submit').addEventListener('click', async (event) => {
                event.preventDefault();

                const title = document.getElementById("title").value;
                const text = editor.getData();
                const errorBox = document.querySelector("#error"); 
                const errorCloseButton = errorBox.querySelector(".close"); 

                if (!title || !text) {
                    document.querySelector("#error-text").textContent = 'Por favor, preencha todos os campos obrigatórios.';
                    errorBox.style.display = "flex";
                    
                    errorCloseButton.addEventListener("click", function () {
                        errorBox.style.display = "none";
                    });
                    return;
                }
    
                const response = id ? await updatePost(id, title, text) : await createPost(title, text);
        
                if (response) {
                    window.location.href = `verPost.html?id=${response.id || id}`;
                }
            });
        }

        const createAction = async () => {
            const myEditor = await initEditor();
            addEventSubmit(myEditor);
        }

        const updateAction = async () => {
            getPost(id).then(async (postArray) => {
                if (postArray.length > 0) {
                    const post = postArray[0]

                    document.getElementById("title").value = post.title;
                    const myEditor = await initEditor(post.text, post.title);
                    console.log('asdasda', myEditor);
                    addEventSubmit(myEditor);
                } else {
                    console.error("Post do not exist");
                }
            });
        }

        if (id) {
            // Edit
            updateAction();
        } else {
            // Create
            createAction();
        }

            
    </script>
  </body> 
</html>